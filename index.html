<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>ç§¯åˆ†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #FF6B6B;
            --primary-dark: #EE5A5A;
            --secondary-color: #4ECDC4;
            --accent-color: #FFE66D;
            --purple-color: #A66CFF;
            --orange-color: #FF9F43;
            --pink-color: #FF85A2;
            --blue-color: #54A0FF;
            --danger-color: #FF6B6B;
            --warning-color: #FF9F43;
            --info-color: #54A0FF;
            --bg-color: #FFF9F0;
            --card-bg: #ffffff;
            --text-primary: #2D3436;
            --text-secondary: #636E72;
            --border-color: #F0E6D8;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 70px;
            padding-top: 10px;
        }

        .sync-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .sync-status.syncing { background: #FFF3E0; color: var(--orange-color); }
        .sync-status.synced { background: #E8FFF5; color: var(--secondary-color); }
        .sync-status.offline { background: #FFE8E8; color: var(--danger-color); }

        .sync-status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .sync-status.syncing .dot { animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .page { display: none; padding: 15px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .score-card {
            background: var(--purple-color);
            color: white;
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 6px 20px rgba(166, 108, 255, 0.3);
        }

        .score-card .label { font-size: 14px; opacity: 0.9; margin-bottom: 5px; }
        .score-card .score { font-size: 48px; font-weight: bold; }
        .score-card .unit { font-size: 18px; opacity: 0.9; }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title .icon { margin-right: 8px; }

        .task-list { list-style: none; }

        .task-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .task-item:last-child { border-bottom: none; }

        .task-checkbox {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            margin-right: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .task-checkbox.completed {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .task-checkbox.completed::after {
            content: 'âœ“';
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .task-info { flex: 1; }
        .task-name { font-size: 15px; margin-bottom: 2px; }
        .task-item.completed .task-name { text-decoration: line-through; color: var(--text-secondary); }

        .task-score { font-size: 14px; font-weight: 600; color: var(--secondary-color); margin-left: 10px; }
        .task-score.negative { color: var(--danger-color); }

        .task-actions { display: flex; gap: 8px; margin-left: 10px; }

        .task-action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .task-action-btn.edit { background: #E8F4FF; color: var(--blue-color); }
        .task-action-btn.delete { background: #FFE8E8; color: var(--danger-color); }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:active { background: var(--primary-dark); transform: scale(0.98); }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-block { width: 100%; }
        .btn-sm { padding: 8px 16px; font-size: 14px; }

        .add-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--orange-color);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reward-category { margin-bottom: 20px; }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 2px solid var(--pink-color);
            margin-bottom: 10px;
        }

        .category-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; }
        .category-title .icon { margin-right: 8px; font-size: 20px; }

        .reward-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--card-bg);
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .reward-info { flex: 1; }
        .reward-name { font-size: 15px; font-weight: 500; }
        .reward-cost { font-size: 14px; color: var(--orange-color); font-weight: 600; }
        .reward-actions { display: flex; gap: 8px; }

        .exchange-btn {
            padding: 8px 16px;
            background: var(--blue-color);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
        }

        .exchange-btn:disabled { background: #ccc; cursor: not-allowed; }

        .history-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--card-bg);
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .history-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 18px;
        }

        .history-icon.income { background: #E8FFF5; color: var(--secondary-color); }
        .history-icon.expense { background: #FFE8E8; color: var(--danger-color); }

        .history-info { flex: 1; }
        .history-desc { font-size: 15px; margin-bottom: 2px; }
        .history-time { font-size: 12px; color: var(--text-secondary); }
        .history-score { font-size: 16px; font-weight: 600; }
        .history-score.positive { color: var(--secondary-color); }
        .history-score.negative { color: var(--danger-color); }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            box-shadow: 0 -2px 15px rgba(0,0,0,0.08);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px 15px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s;
        }

        .nav-item.active { color: var(--primary-color); }
        .nav-item:nth-child(1).active { color: var(--primary-color); }
        .nav-item:nth-child(2).active { color: var(--orange-color); }
        .nav-item:nth-child(3).active { color: var(--pink-color); }
        .nav-item:nth-child(4).active { color: var(--blue-color); }

        .nav-item .icon { font-size: 24px; margin-bottom: 2px; }
        .nav-item .label { font-size: 12px; }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--card-bg);
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title { font-size: 18px; font-weight: 600; }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-body { padding: 20px; }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 6px; color: var(--text-secondary); }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-input:focus { outline: none; border-color: var(--purple-color); }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            background: white;
        }

        .tabs {
            display: flex;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 15px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .tab.active { background: var(--orange-color); color: white; }

        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .empty-state .icon { font-size: 48px; margin-bottom: 10px; }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 15px;
        }

        .quick-btn {
            padding: 18px 15px;
            border: none;
            border-radius: 16px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .quick-btn .icon { font-size: 28px; }
        .quick-btn.add-task { background: #FFE8E8; color: var(--primary-color); }
        .quick-btn.add-reward { background: #FFF4E5; color: var(--orange-color); }
        .quick-btn.manual-adjust { background: #E8FFF5; color: var(--secondary-color); }
        .quick-btn.view-history { background: #F0E8FF; color: var(--purple-color); }

        .date-group { margin-bottom: 20px; }
        .date-header { font-size: 14px; color: var(--text-secondary); padding: 10px 0; font-weight: 500; }

        .confirm-content { text-align: center; padding: 20px 0; }
        .confirm-icon { font-size: 48px; margin-bottom: 15px; }
        .confirm-message { font-size: 16px; color: var(--text-primary); }
        .confirm-sub { font-size: 14px; color: var(--text-secondary); margin-top: 8px; }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top-color: var(--purple-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text { margin-top: 15px; color: var(--text-secondary); }
    </style>
</head>
<body>
    <!-- åŒæ­¥çŠ¶æ€ -->
    <div class="sync-status synced" id="sync-status">
        <span class="dot"></span>
        <span id="sync-text">å·²åŒæ­¥</span>
    </div>

    <!-- åŠ è½½ä¸­ -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">åŠ è½½ä¸­...</div>
    </div>

    <!-- é¦–é¡µ -->
    <div id="page-home" class="page active">
        <div class="score-card">
            <div class="label">å½“å‰ç§¯åˆ†</div>
            <div class="score" id="total-score">0</div>
            <div class="unit">åˆ†</div>
        </div>

        <div class="card">
            <div class="card-title">
                <span><span class="icon">ğŸ“‹</span>ä»Šæ—¥ä»»åŠ¡</span>
                <span id="today-progress">0/0</span>
            </div>
            <ul class="task-list" id="today-tasks"></ul>
            <div class="empty-state" id="today-empty" style="display: none;">
                <div class="icon">ğŸ“</div>
                <div>æš‚æ— ä»Šæ—¥ä»»åŠ¡</div>
            </div>
        </div>

        <div class="quick-actions">
            <button class="quick-btn add-task" onclick="showAddTaskModal()">
                <span class="icon">â•</span>
                <span>æ·»åŠ ä»»åŠ¡</span>
            </button>
            <button class="quick-btn add-reward" onclick="showAddRewardModal()">
                <span class="icon">ğŸ</span>
                <span>æ·»åŠ å¥–åŠ±</span>
            </button>
            <button class="quick-btn manual-adjust" onclick="showAdjustModal()">
                <span class="icon">âœï¸</span>
                <span>æ‰‹åŠ¨è°ƒæ•´</span>
            </button>
            <button class="quick-btn view-history" onclick="switchPage('history')">
                <span class="icon">ğŸ“Š</span>
                <span>æŸ¥çœ‹æ˜ç»†</span>
            </button>
        </div>
    </div>

    <!-- ä»»åŠ¡é¡µ -->
    <div id="page-tasks" class="page">
        <div class="tabs">
            <div class="tab active" onclick="switchTaskTab('daily')">æ—¥å¸¸ä»»åŠ¡</div>
            <div class="tab" onclick="switchTaskTab('temp')">ä¸´æ—¶ä»»åŠ¡</div>
        </div>

        <div id="daily-tasks-section">
            <div class="card">
                <div class="card-title">
                    <span><span class="icon">ğŸ”„</span>æ—¥å¸¸ä»»åŠ¡</span>
                    <button class="add-btn" onclick="showAddTaskModal('daily')">+</button>
                </div>
                <ul class="task-list" id="daily-tasks-list"></ul>
                <div class="empty-state" id="daily-empty" style="display: none;">
                    <div class="icon">ğŸ“</div>
                    <div>æš‚æ— æ—¥å¸¸ä»»åŠ¡</div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-primary btn-sm" onclick="showAddTaskModal('daily')">æ·»åŠ ä»»åŠ¡</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="temp-tasks-section" style="display: none;">
            <div class="card">
                <div class="card-title">
                    <span><span class="icon">ğŸ“Œ</span>ä¸´æ—¶ä»»åŠ¡</span>
                    <button class="add-btn" onclick="showAddTaskModal('temp')">+</button>
                </div>
                <ul class="task-list" id="temp-tasks-list"></ul>
                <div class="empty-state" id="temp-empty" style="display: none;">
                    <div class="icon">ğŸ“</div>
                    <div>æš‚æ— ä¸´æ—¶ä»»åŠ¡</div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-primary btn-sm" onclick="showAddTaskModal('temp')">æ·»åŠ ä»»åŠ¡</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¥–åŠ±é¡µ -->
    <div id="page-rewards" class="page">
        <div class="score-card" style="padding: 15px; background: var(--pink-color);">
            <div class="label">å¯ç”¨ç§¯åˆ†</div>
            <div class="score" style="font-size: 36px;" id="available-score">0</div>
        </div>

        <div id="rewards-container"></div>

        <button class="btn btn-primary btn-block" onclick="showAddRewardModal()" style="margin-top: 15px; background: var(--pink-color);">
            â• æ·»åŠ æ–°å¥–åŠ±
        </button>

        <button class="btn btn-block" style="margin-top: 10px; background: #F0E8FF; color: var(--purple-color);" onclick="showAddCategoryModal()">
            ğŸ“ ç®¡ç†åˆ†ç±»
        </button>
    </div>

    <!-- æ˜ç»†é¡µ -->
    <div id="page-history" class="page">
        <div class="card" style="padding: 12px 15px; background: var(--blue-color); color: white;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>æ€»æ”¶å…¥: <strong id="total-income">0</strong></span>
                <span>æ€»æ”¯å‡º: <strong id="total-expense">0</strong></span>
            </div>
        </div>

        <div id="history-container"></div>

        <div class="empty-state" id="history-empty" style="display: none;">
            <div class="icon">ğŸ“Š</div>
            <div>æš‚æ— è®°å½•</div>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('home')">
            <span class="icon">ğŸ </span>
            <span class="label">é¦–é¡µ</span>
        </div>
        <div class="nav-item" onclick="switchPage('tasks')">
            <span class="icon">ğŸ“‹</span>
            <span class="label">ä»»åŠ¡</span>
        </div>
        <div class="nav-item" onclick="switchPage('rewards')">
            <span class="icon">ğŸ</span>
            <span class="label">å¥–åŠ±</span>
        </div>
        <div class="nav-item" onclick="switchPage('history')">
            <span class="icon">ğŸ“Š</span>
            <span class="label">æ˜ç»†</span>
        </div>
    </nav>

    <!-- æ·»åŠ /ç¼–è¾‘ä»»åŠ¡æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="task-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="task-modal-title">æ·»åŠ ä»»åŠ¡</h3>
                <button class="modal-close" onclick="closeModal('task-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="task-edit-id">
                <div class="form-group">
                    <label class="form-label">ä»»åŠ¡åç§°</label>
                    <input type="text" class="form-input" id="task-name" placeholder="è¾“å…¥ä»»åŠ¡åç§°">
                </div>
                <div class="form-group">
                    <label class="form-label">å®Œæˆå¾—åˆ†</label>
                    <input type="number" class="form-input" id="task-score" placeholder="å®Œæˆä»»åŠ¡è·å¾—çš„ç§¯åˆ†" value="10">
                </div>
                <div class="form-group">
                    <label class="form-label">æœªå®Œæˆæ‰£åˆ†</label>
                    <input type="number" class="form-input" id="task-penalty" placeholder="æœªå®Œæˆæ‰£é™¤çš„ç§¯åˆ†ï¼ˆå¯é€‰ï¼‰" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">ä»»åŠ¡ç±»å‹</label>
                    <select class="form-select" id="task-type">
                        <option value="daily">æ—¥å¸¸ä»»åŠ¡ï¼ˆæ¯å¤©é‡å¤ï¼‰</option>
                        <option value="temp">ä¸´æ—¶ä»»åŠ¡ï¼ˆä¸€æ¬¡æ€§ï¼‰</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="flex: 1; background: var(--bg-color);" onclick="closeModal('task-modal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" style="flex: 1;" onclick="saveTask()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘å¥–åŠ±æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="reward-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="reward-modal-title">æ·»åŠ å¥–åŠ±</h3>
                <button class="modal-close" onclick="closeModal('reward-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="reward-edit-id">
                <div class="form-group">
                    <label class="form-label">å¥–åŠ±åç§°</label>
                    <input type="text" class="form-input" id="reward-name" placeholder="è¾“å…¥å¥–åŠ±åç§°">
                </div>
                <div class="form-group">
                    <label class="form-label">æ‰€éœ€ç§¯åˆ†</label>
                    <input type="number" class="form-input" id="reward-cost" placeholder="å…‘æ¢æ‰€éœ€ç§¯åˆ†" value="50">
                </div>
                <div class="form-group">
                    <label class="form-label">å¥–åŠ±åˆ†ç±»</label>
                    <select class="form-select" id="reward-category"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="flex: 1; background: var(--bg-color);" onclick="closeModal('reward-modal')">å–æ¶ˆ</button>
                <button class="btn" style="flex: 1; background: var(--pink-color); color: white;" onclick="saveReward()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ‰‹åŠ¨è°ƒæ•´ç§¯åˆ†æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="adjust-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">æ‰‹åŠ¨è°ƒæ•´ç§¯åˆ†</h3>
                <button class="modal-close" onclick="closeModal('adjust-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">è°ƒæ•´ç±»å‹</label>
                    <select class="form-select" id="adjust-type">
                        <option value="add">å¢åŠ ç§¯åˆ†</option>
                        <option value="subtract">æ‰£é™¤ç§¯åˆ†</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ç§¯åˆ†æ•°é‡</label>
                    <input type="number" class="form-input" id="adjust-amount" placeholder="è¾“å…¥ç§¯åˆ†æ•°é‡" value="10">
                </div>
                <div class="form-group">
                    <label class="form-label">åŸå› è¯´æ˜</label>
                    <input type="text" class="form-input" id="adjust-reason" placeholder="è¾“å…¥è°ƒæ•´åŸå› ">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="flex: 1; background: var(--bg-color);" onclick="closeModal('adjust-modal')">å–æ¶ˆ</button>
                <button class="btn" style="flex: 1; background: var(--secondary-color); color: white;" onclick="saveAdjust()">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†åˆ†ç±»æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="category-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">ç®¡ç†å¥–åŠ±åˆ†ç±»</h3>
                <button class="modal-close" onclick="closeModal('category-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="category-list"></div>
                <div class="form-group" style="margin-top: 15px;">
                    <label class="form-label">æ·»åŠ æ–°åˆ†ç±»</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-input" id="new-category-name" placeholder="åˆ†ç±»åç§°" style="flex: 1;">
                        <input type="text" class="form-input" id="new-category-icon" placeholder="å›¾æ ‡" style="width: 60px;" value="ğŸ¯">
                        <button class="btn" style="background: var(--orange-color); color: white;" onclick="addCategory()">æ·»åŠ </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-block" style="background: var(--purple-color); color: white;" onclick="closeModal('category-modal')">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <!-- ç¡®è®¤å¯¹è¯æ¡† -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal">
            <div class="modal-body">
                <div class="confirm-content">
                    <div class="confirm-icon" id="confirm-icon">ğŸ</div>
                    <div class="confirm-message" id="confirm-message">ç¡®è®¤å…‘æ¢ï¼Ÿ</div>
                    <div class="confirm-sub" id="confirm-sub"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="flex: 1; background: var(--bg-color);" onclick="closeModal('confirm-modal')">å–æ¶ˆ</button>
                <button class="btn" style="flex: 1; background: var(--blue-color); color: white;" id="confirm-btn" onclick="">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyD-jjoYsx2ZNvCAWFPgDSkID9Zht6LW9a0",
            authDomain: "habit-bank-bc9c7.firebaseapp.com",
            projectId: "habit-bank-bc9c7",
            storageBucket: "habit-bank-bc9c7.firebasestorage.app",
            messagingSenderId: "58240535432",
            appId: "1:58240535432:web:1e0115f6fc464ad702483d"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // æ•°æ®æ–‡æ¡£IDï¼ˆç”¨äºæ ‡è¯†è¿™ä¸ªåº”ç”¨çš„æ•°æ®ï¼‰
        const DATA_DOC_ID = 'main';

        // é»˜è®¤åˆ†ç±»
        const defaultCategories = [
            { id: 'game', name: 'æ¸¸æˆå¨±ä¹', icon: 'ğŸ®' },
            { id: 'shopping', name: 'è´­ç‰©', icon: 'ğŸ›’' },
            { id: 'travel', name: 'æ—…æ¸¸å‡ºè¡Œ', icon: 'âœˆï¸' },
            { id: 'food', name: 'ç¾é£Ÿ', icon: 'ğŸ°' },
            { id: 'other', name: 'å…¶ä»–', icon: 'ğŸ¯' }
        ];

        // åº”ç”¨æ•°æ®
        let appData = {
            score: 0,
            tasks: [],
            rewards: [],
            categories: defaultCategories,
            history: [],
            taskCompletions: {}
        };

        // åŒæ­¥çŠ¶æ€
        let isSyncing = false;
        let isOnline = true;
        const STORAGE_KEY = 'scoreAppData';

        // æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
        function updateSyncStatus(status, text) {
            const statusEl = document.getElementById('sync-status');
            const textEl = document.getElementById('sync-text');
            statusEl.className = 'sync-status ' + status;
            textEl.textContent = text;
        }

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        function saveToLocal() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
            } catch (e) {
                console.error('æœ¬åœ°ä¿å­˜å¤±è´¥:', e);
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½
        function loadFromLocal() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    appData = { ...appData, ...JSON.parse(data) };
                    return true;
                }
            } catch (e) {
                console.error('æœ¬åœ°åŠ è½½å¤±è´¥:', e);
            }
            return false;
        }

        // å¸¦è¶…æ—¶çš„ Promise
        function withTimeout(promise, ms) {
            return Promise.race([
                promise,
                new Promise((_, reject) => setTimeout(() => reject(new Error('è¶…æ—¶')), ms))
            ]);
        }

        // ä¿å­˜æ•°æ®åˆ° Firebaseï¼ˆå¸¦è¶…æ—¶å’Œç¦»çº¿å›é€€ï¼‰
        async function saveToCloud() {
            // å…ˆä¿å­˜åˆ°æœ¬åœ°
            saveToLocal();
            
            if (isSyncing) return;
            isSyncing = true;
            updateSyncStatus('syncing', 'åŒæ­¥ä¸­...');

            try {
                await withTimeout(db.collection('scoreApp').doc(DATA_DOC_ID).set(appData), 5000);
                isOnline = true;
                updateSyncStatus('synced', 'å·²åŒæ­¥');
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                isOnline = false;
                updateSyncStatus('offline', 'ç¦»çº¿æ¨¡å¼');
            }

            isSyncing = false;
        }

        // ä» Firebase åŠ è½½æ•°æ®ï¼ˆå¸¦è¶…æ—¶å’Œç¦»çº¿å›é€€ï¼‰
        async function loadFromCloud() {
            // å…ˆå°è¯•ä»æœ¬åœ°åŠ è½½
            const hasLocal = loadFromLocal();
            
            try {
                const doc = await withTimeout(db.collection('scoreApp').doc(DATA_DOC_ID).get(), 5000);
                if (doc.exists) {
                    appData = { ...appData, ...doc.data() };
                    saveToLocal(); // åŒæ­¥åˆ°æœ¬åœ°
                } else if (!hasLocal) {
                    // é¦–æ¬¡ä½¿ç”¨ï¼Œåˆ›å»ºé»˜è®¤æ•°æ®
                    await saveToCloud();
                }
                isOnline = true;
                updateSyncStatus('synced', 'å·²åŒæ­¥');
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                isOnline = false;
                if (hasLocal) {
                    updateSyncStatus('offline', 'ç¦»çº¿æ¨¡å¼');
                } else {
                    updateSyncStatus('offline', 'ç¦»çº¿æ¨¡å¼');
                }
            }
        }

        // ç›‘å¬å®æ—¶æ›´æ–°
        function listenToChanges() {
            try {
                db.collection('scoreApp').doc(DATA_DOC_ID).onSnapshot((doc) => {
                    if (doc.exists && !isSyncing) {
                        appData = { ...appData, ...doc.data() };
                        saveToLocal(); // åŒæ­¥åˆ°æœ¬åœ°
                        refreshAllPages();
                        isOnline = true;
                        updateSyncStatus('synced', 'å·²åŒæ­¥');
                    }
                }, (error) => {
                    console.error('ç›‘å¬å¤±è´¥:', error);
                    isOnline = false;
                    updateSyncStatus('offline', 'è¿æ¥æ–­å¼€');
                });
            } catch (error) {
                console.error('ç›‘å¬è®¾ç½®å¤±è´¥:', error);
                isOnline = false;
                updateSyncStatus('offline', 'ç¦»çº¿æ¨¡å¼');
            }
        }

        // åˆ·æ–°æ‰€æœ‰é¡µé¢
        function refreshAllPages() {
            updateScoreDisplay();
            renderTodayTasks();
            renderTasksList();
            renderRewards();
            renderHistory();
        }

        // ç”Ÿæˆå”¯ä¸€ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // è·å–ä»Šå¤©çš„æ—¥æœŸå­—ç¬¦ä¸²
        function getTodayStr() {
            return new Date().toISOString().split('T')[0];
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const today = getTodayStr();
            const dateStr = date.toISOString().split('T')[0];
            const timeStr = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });

            if (dateStr === today) {
                return 'ä»Šå¤© ' + timeStr;
            } else if (dateStr === new Date(now - 86400000).toISOString().split('T')[0]) {
                return 'æ˜¨å¤© ' + timeStr;
            } else {
                return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }) + ' ' + timeStr;
            }
        }

        // é¡µé¢åˆ‡æ¢
        function switchPage(pageName) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById('page-' + pageName).classList.add('active');

            document.querySelectorAll('.nav-item').forEach((item, index) => {
                item.classList.remove('active');
                const pages = ['home', 'tasks', 'rewards', 'history'];
                if (pages[index] === pageName) item.classList.add('active');
            });

            refreshPage(pageName);
        }

        function refreshPage(pageName) {
            switch(pageName) {
                case 'home': renderTodayTasks(); updateScoreDisplay(); break;
                case 'tasks': renderTasksList(); break;
                case 'rewards': renderRewards(); updateScoreDisplay(); break;
                case 'history': renderHistory(); break;
            }
        }

        // ä»»åŠ¡æ ‡ç­¾åˆ‡æ¢
        function switchTaskTab(tab) {
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            if (tab === 'daily') {
                document.getElementById('daily-tasks-section').style.display = 'block';
                document.getElementById('temp-tasks-section').style.display = 'none';
            } else {
                document.getElementById('daily-tasks-section').style.display = 'none';
                document.getElementById('temp-tasks-section').style.display = 'block';
            }
        }

        // æ¸²æŸ“ä»Šæ—¥ä»»åŠ¡
        function renderTodayTasks() {
            const today = getTodayStr();
            const todayTasks = appData.tasks.filter(task => {
                if (task.type === 'daily') return true;
                if (task.type === 'temp' && task.createdDate === today) return true;
                return false;
            });

            const container = document.getElementById('today-tasks');
            const emptyState = document.getElementById('today-empty');

            if (todayTasks.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                document.getElementById('today-progress').textContent = '0/0';
                return;
            }

            emptyState.style.display = 'none';
            let completedCount = 0;

            container.innerHTML = todayTasks.map(task => {
                const completions = appData.taskCompletions || {};
                const isCompleted = completions[today] && completions[today][task.id];
                if (isCompleted) completedCount++;

                return `
                    <li class="task-item ${isCompleted ? 'completed' : ''}">
                        <div class="task-checkbox ${isCompleted ? 'completed' : ''}" 
                             onclick="toggleTaskCompletion('${task.id}')"></div>
                        <div class="task-info">
                            <div class="task-name">${task.name}</div>
                        </div>
                        <div class="task-score">+${task.score}</div>
                    </li>
                `;
            }).join('');

            document.getElementById('today-progress').textContent = `${completedCount}/${todayTasks.length}`;
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTasksList() {
            const today = getTodayStr();
            const completions = appData.taskCompletions || {};

            // æ—¥å¸¸ä»»åŠ¡
            const dailyTasks = appData.tasks.filter(t => t.type === 'daily');
            const dailyContainer = document.getElementById('daily-tasks-list');
            const dailyEmpty = document.getElementById('daily-empty');

            if (dailyTasks.length === 0) {
                dailyContainer.innerHTML = '';
                dailyEmpty.style.display = 'block';
            } else {
                dailyEmpty.style.display = 'none';
                dailyContainer.innerHTML = dailyTasks.map(task => {
                    const isCompleted = completions[today] && completions[today][task.id];
                    return `
                        <li class="task-item ${isCompleted ? 'completed' : ''}">
                            <div class="task-checkbox ${isCompleted ? 'completed' : ''}" 
                                 onclick="toggleTaskCompletion('${task.id}')"></div>
                            <div class="task-info">
                                <div class="task-name">${task.name}</div>
                            </div>
                            <div class="task-score">+${task.score}${task.penalty > 0 ? ' / -' + task.penalty : ''}</div>
                            <div class="task-actions">
                                <button class="task-action-btn edit" onclick="editTask('${task.id}')">âœï¸</button>
                                <button class="task-action-btn delete" onclick="deleteTask('${task.id}')">ğŸ—‘ï¸</button>
                            </div>
                        </li>
                    `;
                }).join('');
            }

            // ä¸´æ—¶ä»»åŠ¡
            const tempTasks = appData.tasks.filter(t => t.type === 'temp');
            const tempContainer = document.getElementById('temp-tasks-list');
            const tempEmpty = document.getElementById('temp-empty');

            if (tempTasks.length === 0) {
                tempContainer.innerHTML = '';
                tempEmpty.style.display = 'block';
            } else {
                tempEmpty.style.display = 'none';
                tempContainer.innerHTML = tempTasks.map(task => {
                    const isCompleted = completions[task.createdDate] && completions[task.createdDate][task.id];
                    return `
                        <li class="task-item ${isCompleted ? 'completed' : ''}">
                            <div class="task-checkbox ${isCompleted ? 'completed' : ''}" 
                                 onclick="toggleTaskCompletion('${task.id}')"></div>
                            <div class="task-info">
                                <div class="task-name">${task.name}</div>
                            </div>
                            <div class="task-score">+${task.score}${task.penalty > 0 ? ' / -' + task.penalty : ''}</div>
                            <div class="task-actions">
                                <button class="task-action-btn edit" onclick="editTask('${task.id}')">âœï¸</button>
                                <button class="task-action-btn delete" onclick="deleteTask('${task.id}')">ğŸ—‘ï¸</button>
                            </div>
                        </li>
                    `;
                }).join('');
            }
        }

        // åˆ‡æ¢ä»»åŠ¡å®ŒæˆçŠ¶æ€
        function toggleTaskCompletion(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;

            const today = getTodayStr();
            const dateKey = task.type === 'daily' ? today : task.createdDate;

            if (!appData.taskCompletions) appData.taskCompletions = {};
            if (!appData.taskCompletions[dateKey]) appData.taskCompletions[dateKey] = {};

            const wasCompleted = appData.taskCompletions[dateKey][taskId];
            appData.taskCompletions[dateKey][taskId] = !wasCompleted;

            if (!wasCompleted) {
                appData.score += task.score;
                appData.history.unshift({
                    id: generateId(),
                    type: 'task_complete',
                    description: `å®Œæˆä»»åŠ¡: ${task.name}`,
                    amount: task.score,
                    timestamp: Date.now()
                });
            } else {
                appData.score -= task.score;
                appData.history.unshift({
                    id: generateId(),
                    type: 'task_cancel',
                    description: `å–æ¶ˆå®Œæˆ: ${task.name}`,
                    amount: -task.score,
                    timestamp: Date.now()
                });
            }

            // å…ˆæ›´æ–°UIï¼Œç„¶åå¼‚æ­¥ä¿å­˜åˆ°äº‘ç«¯
            renderTodayTasks();
            renderTasksList();
            updateScoreDisplay();
            saveToCloud(); // ä¸ç­‰å¾…ï¼Œå¼‚æ­¥æ‰§è¡Œ
        }

        // æ˜¾ç¤ºæ·»åŠ ä»»åŠ¡æ¨¡æ€æ¡†
        function showAddTaskModal(type = 'daily') {
            document.getElementById('task-modal-title').textContent = 'æ·»åŠ ä»»åŠ¡';
            document.getElementById('task-edit-id').value = '';
            document.getElementById('task-name').value = '';
            document.getElementById('task-score').value = '10';
            document.getElementById('task-penalty').value = '0';
            document.getElementById('task-type').value = type;
            openModal('task-modal');
        }

        // ç¼–è¾‘ä»»åŠ¡
        function editTask(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;

            document.getElementById('task-modal-title').textContent = 'ç¼–è¾‘ä»»åŠ¡';
            document.getElementById('task-edit-id').value = task.id;
            document.getElementById('task-name').value = task.name;
            document.getElementById('task-score').value = task.score;
            document.getElementById('task-penalty').value = task.penalty || 0;
            document.getElementById('task-type').value = task.type;
            openModal('task-modal');
        }

        // ä¿å­˜ä»»åŠ¡
        function saveTask() {
            const editId = document.getElementById('task-edit-id').value;
            const name = document.getElementById('task-name').value.trim();
            const score = parseInt(document.getElementById('task-score').value) || 0;
            const penalty = parseInt(document.getElementById('task-penalty').value) || 0;
            const type = document.getElementById('task-type').value;

            if (!name) {
                alert('è¯·è¾“å…¥ä»»åŠ¡åç§°');
                return;
            }

            if (editId) {
                const index = appData.tasks.findIndex(t => t.id === editId);
                if (index !== -1) {
                    appData.tasks[index] = { ...appData.tasks[index], name, score, penalty, type };
                }
            } else {
                appData.tasks.push({
                    id: generateId(),
                    name,
                    score,
                    penalty,
                    type,
                    createdDate: getTodayStr()
                });
            }

            // å…ˆå…³é—­æ¨¡æ€æ¡†å’Œæ›´æ–°UIï¼Œç„¶åå¼‚æ­¥ä¿å­˜åˆ°äº‘ç«¯
            closeModal('task-modal');
            renderTodayTasks();
            renderTasksList();
            saveToCloud(); // ä¸ç­‰å¾…ï¼Œå¼‚æ­¥æ‰§è¡Œ
        }

        // åˆ é™¤ä»»åŠ¡
        function deleteTask(taskId) {
            showConfirm('ğŸ—‘ï¸', 'ç¡®è®¤åˆ é™¤æ­¤ä»»åŠ¡ï¼Ÿ', 'åˆ é™¤åæ— æ³•æ¢å¤', () => {
                appData.tasks = appData.tasks.filter(t => t.id !== taskId);
                renderTodayTasks();
                renderTasksList();
                saveToCloud(); // ä¸ç­‰å¾…ï¼Œå¼‚æ­¥æ‰§è¡Œ
            });
        }

        // æ¸²æŸ“å¥–åŠ±
        function renderRewards() {
            document.getElementById('available-score').textContent = appData.score;

            const container = document.getElementById('rewards-container');

            if (appData.rewards.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ</div>
                        <div>æš‚æ— å¥–åŠ±</div>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-sm" style="background: var(--pink-color); color: white;" onclick="showAddRewardModal()">æ·»åŠ å¥–åŠ±</button>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = appData.categories.map(category => {
                const categoryRewards = appData.rewards.filter(r => r.categoryId === category.id);
                if (categoryRewards.length === 0) return '';

                return `
                    <div class="reward-category">
                        <div class="category-header">
                            <div class="category-title">
                                <span class="icon">${category.icon}</span>
                                ${category.name}
                            </div>
                        </div>
                        ${categoryRewards.map(reward => `
                            <div class="reward-item">
                                <div class="reward-info">
                                    <div class="reward-name">${reward.name}</div>
                                    <div class="reward-cost">éœ€è¦ ${reward.cost} ç§¯åˆ†</div>
                                </div>
                                <div class="reward-actions">
                                    <button class="task-action-btn edit" onclick="editReward('${reward.id}')">âœï¸</button>
                                    <button class="task-action-btn delete" onclick="deleteReward('${reward.id}')">ğŸ—‘ï¸</button>
                                    <button class="exchange-btn" 
                                            onclick="exchangeReward('${reward.id}')"
                                            ${appData.score < reward.cost ? 'disabled' : ''}>
                                        å…‘æ¢
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');
        }

        // æ˜¾ç¤ºæ·»åŠ å¥–åŠ±æ¨¡æ€æ¡†
        function showAddRewardModal() {
            document.getElementById('reward-modal-title').textContent = 'æ·»åŠ å¥–åŠ±';
            document.getElementById('reward-edit-id').value = '';
            document.getElementById('reward-name').value = '';
            document.getElementById('reward-cost').value = '50';

            document.getElementById('reward-category').innerHTML = appData.categories.map(c =>
                `<option value="${c.id}">${c.icon} ${c.name}</option>`
            ).join('');

            openModal('reward-modal');
        }

        // ç¼–è¾‘å¥–åŠ±
        function editReward(rewardId) {
            const reward = appData.rewards.find(r => r.id === rewardId);
            if (!reward) return;

            document.getElementById('reward-modal-title').textContent = 'ç¼–è¾‘å¥–åŠ±';
            document.getElementById('reward-edit-id').value = reward.id;
            document.getElementById('reward-name').value = reward.name;
            document.getElementById('reward-cost').value = reward.cost;

            document.getElementById('reward-category').innerHTML = appData.categories.map(c =>
                `<option value="${c.id}" ${c.id === reward.categoryId ? 'selected' : ''}>${c.icon} ${c.name}</option>`
            ).join('');

            openModal('reward-modal');
        }

        // ä¿å­˜å¥–åŠ±
        function saveReward() {
            const editId = document.getElementById('reward-edit-id').value;
            const name = document.getElementById('reward-name').value.trim();
            const cost = parseInt(document.getElementById('reward-cost').value) || 0;
            const categoryId = document.getElementById('reward-category').value;

            if (!name) {
                alert('è¯·è¾“å…¥å¥–åŠ±åç§°');
                return;
            }

            if (editId) {
                const index = appData.rewards.findIndex(r => r.id === editId);
                if (index !== -1) {
                    appData.rewards[index] = { ...appData.rewards[index], name, cost, categoryId };
                }
            } else {
                appData.rewards.push({
                    id: generateId(),
                    name,
                    cost,
                    categoryId
                });
            }

            // å…ˆå…³é—­æ¨¡æ€æ¡†å’Œæ›´æ–°UIï¼Œç„¶åå¼‚æ­¥ä¿å­˜åˆ°äº‘ç«¯
            closeModal('reward-modal');
            renderRewards();
            saveToCloud(); // ä¸ç­‰å¾…ï¼Œå¼‚æ­¥æ‰§è¡Œ
        }

        // åˆ é™¤å¥–åŠ±
        function deleteReward(rewardId) {
            showConfirm('ğŸ—‘ï¸', 'ç¡®è®¤åˆ é™¤æ­¤å¥–åŠ±ï¼Ÿ', 'åˆ é™¤åæ— æ³•æ¢å¤', () => {
                appData.rewards = appData.rewards.filter(r => r.id !== rewardId);
                renderRewards();
                saveToCloud(); // ä¸ç­‰å¾…ï¼Œå¼‚æ­¥æ‰§è¡Œ
            });
        }

        // å…‘æ¢å¥–åŠ±
        function exchangeReward(rewardId) {
            const reward = appData.rewards.find(r => r.id === rewardId);
            if (!reward) return;

            if (appData.score < reward.cost) {
                alert('ç§¯åˆ†ä¸è¶³ï¼');
                return;
            }

            showConfirm('ğŸ', `ç¡®è®¤å…‘æ¢ã€Œ${reward.name}ã€ï¼Ÿ`, `å°†æ‰£é™¤ ${reward.cost} ç§¯åˆ†`, () => {
                appData.score -= reward.cost;
                appData.history.unshift({
                    id: generateId(),
                    type: 'exchange',
                    description: `å…‘æ¢å¥–åŠ±: ${reward.name}`,
                    amount: -reward.cost,
                    timestamp: Date.now()
                });

                renderRewards();
                updateScoreDisplay();
                alert('å…‘æ¢æˆåŠŸï¼ğŸ‰');
                saveToCloud(); // ä¸ç­‰å¾…ï¼Œå¼‚æ­¥æ‰§è¡Œ
            });
        }

        // æ˜¾ç¤ºåˆ†ç±»ç®¡ç†æ¨¡æ€æ¡†
        function showAddCategoryModal() {
            renderCategoryList();
            openModal('category-modal');
        }

        // æ¸²æŸ“åˆ†ç±»åˆ—è¡¨
        function renderCategoryList() {
            const container = document.getElementById('category-list');
            container.innerHTML = appData.categories.map(c => `
                <div class="reward-item" style="margin-bottom: 8px;">
                    <div class="reward-info">
                        <div class="reward-name">${c.icon} ${c.name}</div>
                    </div>
                    <button class="task-action-btn delete" onclick="deleteCategory('${c.id}')">ğŸ—‘ï¸</button>
                </div>
            `).join('');
        }

        // æ·»åŠ åˆ†ç±»
        function addCategory() {
            const name = document.getElementById('new-category-name').value.trim();
            const icon = document.getElementById('new-category-icon').value.trim() || 'ğŸ¯';

            if (!name) {
                alert('è¯·è¾“å…¥åˆ†ç±»åç§°');
                return;
            }

            appData.categories.push({
                id: generateId(),
                name,
                icon
            });

            document.getElementById('new-category-name').value = '';
            document.getElementById('new-category-icon').value = 'ğŸ¯';
            renderCategoryList();
            saveToCloud(); // ä¸ç­‰å¾…ï¼Œå¼‚æ­¥æ‰§è¡Œ
        }

        // åˆ é™¤åˆ†ç±»
        function deleteCategory(categoryId) {
            if (appData.categories.length <= 1) {
                alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªåˆ†ç±»');
                return;
            }

            appData.categories = appData.categories.filter(c => c.id !== categoryId);

            const firstCategoryId = appData.categories[0].id;
            appData.rewards.forEach(r => {
                if (r.categoryId === categoryId) {
                    r.categoryId = firstCategoryId;
                }
            });

            renderCategoryList();
            saveToCloud(); // ä¸ç­‰å¾…ï¼Œå¼‚æ­¥æ‰§è¡Œ
        }

        // æ˜¾ç¤ºè°ƒæ•´ç§¯åˆ†æ¨¡æ€æ¡†
        function showAdjustModal() {
            document.getElementById('adjust-type').value = 'add';
            document.getElementById('adjust-amount').value = '10';
            document.getElementById('adjust-reason').value = '';
            openModal('adjust-modal');
        }

        // ä¿å­˜è°ƒæ•´
        function saveAdjust() {
            const type = document.getElementById('adjust-type').value;
            const amount = parseInt(document.getElementById('adjust-amount').value) || 0;
            const reason = document.getElementById('adjust-reason').value.trim() || (type === 'add' ? 'æ‰‹åŠ¨å¢åŠ ' : 'æ‰‹åŠ¨æ‰£é™¤');

            if (amount <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç§¯åˆ†æ•°é‡');
                return;
            }

            if (type === 'add') {
                appData.score += amount;
                appData.history.unshift({
                    id: generateId(),
                    type: 'manual_add',
                    description: reason,
                    amount: amount,
                    timestamp: Date.now()
                });
            } else {
                appData.score -= amount;
                appData.history.unshift({
                    id: generateId(),
                    type: 'manual_subtract',
                    description: reason,
                    amount: -amount,
                    timestamp: Date.now()
                });
            }

            // å…ˆå…³é—­æ¨¡æ€æ¡†å’Œæ›´æ–°UIï¼Œç„¶åå¼‚æ­¥ä¿å­˜åˆ°äº‘ç«¯
            closeModal('adjust-modal');
            updateScoreDisplay();
            renderHistory();
            saveToCloud(); // ä¸ç­‰å¾…ï¼Œå¼‚æ­¥æ‰§è¡Œ
        }

        // æ¸²æŸ“å†å²è®°å½•
        function renderHistory() {
            const container = document.getElementById('history-container');
            const emptyState = document.getElementById('history-empty');

            if (appData.history.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                document.getElementById('total-income').textContent = '0';
                document.getElementById('total-expense').textContent = '0';
                return;
            }

            emptyState.style.display = 'none';

            let totalIncome = 0;
            let totalExpense = 0;
            appData.history.forEach(item => {
                if (item.amount > 0) totalIncome += item.amount;
                else totalExpense += Math.abs(item.amount);
            });

            document.getElementById('total-income').textContent = totalIncome;
            document.getElementById('total-expense').textContent = totalExpense;

            const grouped = {};
            appData.history.forEach(item => {
                const date = new Date(item.timestamp).toISOString().split('T')[0];
                if (!grouped[date]) grouped[date] = [];
                grouped[date].push(item);
            });

            container.innerHTML = Object.keys(grouped).map(date => {
                const items = grouped[date];
                const dateObj = new Date(date);
                const today = getTodayStr();
                const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

                let dateLabel = dateObj.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' });
                if (date === today) dateLabel = 'ä»Šå¤©';
                else if (date === yesterday) dateLabel = 'æ˜¨å¤©';

                return `
                    <div class="date-group">
                        <div class="date-header">${dateLabel}</div>
                        ${items.map(item => `
                            <div class="history-item">
                                <div class="history-icon ${item.amount > 0 ? 'income' : 'expense'}">
                                    ${item.amount > 0 ? 'ğŸ“ˆ' : 'ğŸ“‰'}
                                </div>
                                <div class="history-info">
                                    <div class="history-desc">${item.description}</div>
                                    <div class="history-time">${formatTime(item.timestamp)}</div>
                                </div>
                                <div class="history-score ${item.amount > 0 ? 'positive' : 'negative'}">
                                    ${item.amount > 0 ? '+' : ''}${item.amount}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°ç§¯åˆ†æ˜¾ç¤º
        function updateScoreDisplay() {
            document.getElementById('total-score').textContent = appData.score;
            document.getElementById('available-score').textContent = appData.score;
        }

        // æ¨¡æ€æ¡†æ“ä½œ
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showConfirm(icon, message, sub, callback) {
            document.getElementById('confirm-icon').textContent = icon;
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('confirm-sub').textContent = sub;
            document.getElementById('confirm-btn').onclick = () => {
                closeModal('confirm-modal');
                callback();
            };
            openModal('confirm-modal');
        }

        // éšè—åŠ è½½ç•Œé¢
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // åˆå§‹åŒ–
        async function init() {
            await loadFromCloud();
            listenToChanges();
            refreshAllPages();
            hideLoading();
        }

        // å¯åŠ¨åº”ç”¨
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>